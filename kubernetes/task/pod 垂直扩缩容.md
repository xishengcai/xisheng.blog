# Autopilot: workload autoscaling at Google



在云计算平台上部署应用程序，经常出现资源分配不合理的现象，单个应用计算资源分配过高属于浪费，分配过低影响性能甚至OOM。
为了解决这个问题，Google使用Autopilot自动配置资源，同时调整作业中的并发任务数（水平缩放）和单个任务的CPU /内存限制（垂直缩放）

1. 很难估算一个工作负载实例需要多少资源才是合理的
2. 资源使用是个动态值，即使当前设定是合理的，随着业务的变化也可能是不合理的

总结： 手动配置的资源永远都不准确



## Autopilot 工作机制
### 算法
1. 依赖于历史用量的指数平滑滑动窗口
2. 元学习：具备自学能力，能够充分利用过去的经验来指导未来的任务。被认为是实现通用人工智能的关键

### 架构
Autopilot的功能体系结构是三合一的闭环控制系统
- 水平缩放
- CPU垂直缩放
- 内存垂直缩放

![1616468931618.png](https://cai-hello-1253732611.cos.ap-shanghai.myqcloud.com/share/161643.png)

Autopilot的实现（上图）采用架构上的一组标准作业的形式：每个集群都有自己的Autopilot。Recommenders可以看作是高可用的Autopilot服务，
该服务将估算出的最佳资源分配大小推荐给BrogMaster（可以看成是K8s master), BrogMaster 修改配额， 工作负载实际运行的集群节点Broglet（可以看成是node kubelet）调用cgroup 限制容器配额。


### 垂直自动缩放
Autopilot服务会根据任务选择作业推荐器（cpu 或 内存 推荐器）

预处理（汇总输入信号） --> 推荐算法处理 --> 云计算平台实施资源管理

#### 预处理
低级任务监控记录原始信号是针对一项工作的每个任务的时间测量序列。 我们将监视系统在任务time的时间recorded记录为𝑟𝑖[𝜏]。 此时间序列通常每1秒包含一个样本。为了减少设置作业限制时存储和处理的数据量，我们的监视系统将𝑟𝑖[𝜏]预处理为汇总信号𝑠[𝑡]汇总信号𝑠[𝑡]的一个样本是一个直方图，总结了这5分钟内所有工作任务的资源使用情况。

#### 推荐算法
略

#### 实施资源管理
Borg允许作业在作业运行时修改其资源需求。在水平缩放中，作业可以动态添加或删除任务。在垂直扩展中，作业可以更改其任务的RAM和CPU限制。增加作业的RAM和CPU限制是一项潜在的高成本操作，因为某些任务可能不再适合他们的计算机。在这种情况下，这些计算机上的Borglet将终止一些优先级较低的任务；反过来，这些任务将重新安排到其他计算机上，并可能触发其他优先级更低的任务的终止。 

- 在承载workload 的节点资源足够的情况下，能不停止运行workload的情况下修改资源配额
- 在承载workload 机节点源不足的情况下，会kill 本节点的其他低级别workload，或者是迁移本workload到其他节点上

### 水平自动缩放
单个工作负载使用的资源是无法超过承载它的计算机的。为了解决这个问题，Autopilot水平缩放可根据作业的负载动态更改工作负载中的任务数量（副本）

CPU使用率：作业所有者指定
1. CPU使用率信号的平均窗口（默认为5分钟
2. 视界长度𝑇（默认视界为72小时）
3. 统计𝑆：max或𝑃95，即95％ile； 
4. 目标平均利用率。 Autopilot根据最新T利用率样本的值time在时间time处计算副本数number [𝑡] = 𝑆𝜏∈[𝑡−𝑇，𝑡] {𝑖𝑟𝑖[𝜏]}。 然后，原始建议的副本数为𝑛𝑟[𝑡] =𝑟𝑆[𝑡] /𝑟∗。

目标大小：作业所有者指定用于计算任务数量的函数，即𝑛𝑟[𝑡] =𝑓[𝑡]。 该功能使用来自作业监视系统的数据。 例如，使用排队系统管理请求的作业可以按请求处理时间的95％缩放； 文件系统服务器可能会根据其管理的文件空间量进行扩展。


## 当前行业应用背景
### 阿里云

- 更新正在运行的Pod资源配置是VPA的一项试验性功能，会导致Pod的重建和重启，而且有可能被调度到其他的节点上。
- VPA不会驱逐没有在副本控制器管理下的Pod。目前对于这类Pod，Auto模式等同于Initial模式。
- 目前VPA不能和监控CPU和内存度量的Horizontal Pod Autoscaler （HPA）同时运行，除非HPA只监控其他定制化的或者外部的资源度量。
- VPA使用admission webhook作为其准入控制器。如果集群中有其他的admission webhook，需要确保它们不会与VPA发生冲突。准入控制器的执行顺序定义在API Server的配置参数中。
- VPA会处理绝大多数OOM（Out Of Memory）的事件，但不保证所有的场景下都有效。
- VPA的性能还没有在大型集群中测试过。
- VPA对Pod资源requests的修改值可能超过实际的资源上限，例如节点资源上限、空闲资源或资源配额，从而造成Pod处于Pending状态无法被调度。同时使用集群自动伸缩（ClusterAutoscaler）可以一定程度上解决这个问题。
- 多个VPA同时匹配同一个Pod会造成未定义的行为。


## 应用前景
自动扩缩对于云来说效率、可靠性、运维工作量至关重要。手动设置的限制不仅浪费资源（平均配置限制太高），而且随着负载增加或新版本的服务推出时，会导致频繁违反限制。Autopilot是Google使用的垂直和水平自动缩放工具。通过自动提高限制设置的精度，它减少了资源浪费并提高了可靠性：内存不足错误不那么常见，不那么严重，并且减少任务间项目影响。使用简单的时间加权滑动窗口算法可以实现其中一些增益，但是切换到受强化学习启发的更复杂的算法可以实现更大的增益。

**收益**
- 在应用界面去除资源配置项，可以获得更愉快的用户体验。
- 如果算法可靠，可以减少资源闲置
- 可以减少OOM频次

**link**
 - [中文翻译](https://www.jianshu.com/p/12f09b0e0839)
 - [滑动窗口算法](http://0fd.org/2020/09/05/autopilot-workload-autoscaling-at-google/)
 - [论文地址](https://dl.acm.org/doi/pdf/10.1145/3342195.3387524)
 - [阿里云VPA](https://help.aliyun.com/document_detail/173702.html)